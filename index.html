<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>仿iPhone主页</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #f2f2f2;
            --card-bg: rgba(255, 255, 255, 0.85);
            --text-color: #333;
            --secondary-text: #666;
            --accent-color: #007aff;
            --dock-bg: rgba(255, 255, 255, 0.45);
        }

        [data-theme="dark"] {
            --bg-color: #1c1c1e;
            --card-bg: rgba(44, 44, 46, 0.85);
            --text-color: #fff;
            --secondary-text: #aeaeb2;
            --accent-color: #0a84ff;
            --dock-bg: rgba(30, 30, 30, 0.45);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "San Francisco", "Helvetica Neue", sans-serif;
            overflow: hidden;
            /* 居中布局 */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 仿iPhone容器 */
        .iphone-container {
            background-color: var(--bg-color);
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
            transition: background-color 0.3s;
            /* 默认全屏 (移动端/小屏) */
            width: 100%;
            height: 100%;
        }

        /* 电脑端/大屏适配 (仿iPhone外观) */
        @media (min-width: 768px) {
            body {
                /* 电脑屏幕背景 */
                background-color: #eef2f5;
                background-image: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            }
            .iphone-container {
                width: 390px;
                height: 844px;
                max-height: 95vh; /* 确保不超出视口高度 */
                border-radius: 55px; /* 机身圆角 */
                box-shadow: 
                    0 0 0 12px #222, /* 模拟黑色边框 */
                    0 0 0 14px #555, /* 模拟金属边 */
                    0 30px 60px rgba(0,0,0,0.4); /* 阴影 */
            }
        }

        /* 滚动区域 */
        .scroll-area {
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: calc(90px + env(safe-area-inset-bottom)); /* Dock栏高度预留 + 安全区域 */
        }
        .scroll-area::-webkit-scrollbar { display: none; }

        /* ================== 状态栏 ================== */
        .status-bar {
            height: 47px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 0 26px 10px;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-color);
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1000;
            pointer-events: none;
        }
        .sb-right { display: flex; gap: 6px; align-items: center; }
        .battery-icon { font-size: 20px; }

        /* ================== 主页模块 ================== */
        .page-content {
            padding: 100px 20px 20px; /* 增加顶部间距，避开状态栏 */
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 100%;
        }

        /* 模块B: 用户资料卡 */
        .user-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 30px 20px; /* 增加内部空间 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px; /* 头像和输入框的间距 */
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            position: relative;
            margin-top: 0; /* 移除额外的顶部边距 */
            min-height: 220px; /* 确保卡片有足够高度 */
        }

        .avatar-container {
            margin-top: 0; /* 移除负边距，让头像在卡片内 */
            margin-bottom: 0;
            position: relative;
        }

        .avatar {
            width: 110px; /* 稍微加大头像 */
            height: 110px;
            border-radius: 50%;
            background-color: #ddd;
            background-image: url('https://api.dicebear.com/7.x/avataaars/svg?seed=Felix');
            background-size: cover;
            background-position: center;
            border: 4px solid rgba(255,255,255,0.8); /* 调整边框颜色 */
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .avatar:active { transform: scale(0.95); }

        .status-input {
            width: 90%; /* 稍微收窄宽度 */
            padding: 12px 20px;
            border-radius: 30px; /* 变成椭圆形 */
            border: 1px solid rgba(0,0,0,0.05);
            background: rgba(255,255,255,0.8); /* 背景更白一点 */
            color: var(--text-color);
            font-size: 14px;
            outline: none;
            text-align: center;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        }
        .status-input:focus { background: #fff; }

        /* 中间区域布局：左侧纪念日 + 右侧网格 */
        .mid-section {
            display: flex;
            gap: 15px;
            height: 180px; /* 固定高度以保持整齐 */
        }

        /* 模块D: 纪念日卡片 (左侧) */
        .memorial-widget {
            flex: 1;
            background: #fff;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
        }
        .memorial-widget:active { transform: scale(0.98); }
        
        /* 图片占据上半部分或铺满 */
        .memorial-bg {
            width: 100%; 
            height: 100%;
            object-fit: cover;
            position: absolute; 
            top: 0; left: 0;
            z-index: 0;
        }
        
        /* 下半部分毛玻璃区域 */
        .memorial-overlay {
            position: absolute; 
            bottom: 0; left: 0; right: 0;
            height: 35%; /* 占据下半部分 */
            background: rgba(255, 255, 255, 0.2); /* 半透明白 */
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255,255,255,0.2);
            border-radius: 0; /* 强制直角 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #333;
            z-index: 1;
        }
        .memorial-label { font-size: 11px; color: #555; margin-bottom: 2px; font-weight: 500;}
        .memorial-count { font-size: 20px; font-weight: 800; color: #333; }
        
        .memorial-empty {
            height: 100%; display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            color: #999; gap: 10px; background: #f9f9f9;
            z-index: 2; position: relative;
        }

        /* 模块C: 应用网格 (右侧) */
        .app-grid {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 10px;
        }

        .app-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .app-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            transition: transform 0.2s;
            position: relative;
            background-size: cover;
            background-position: center;
            overflow: hidden;
        }
        .app-icon i { pointer-events: none; }
        .app-item:active .app-icon { transform: scale(0.9); }

        .app-label { font-size: 10px; color: var(--text-color); font-weight: 500; }

        .bg-green { background: linear-gradient(135deg, #36D1DC, #5B86E5); } /* 微信风格 (用蓝色系替代避免版权太像，或者用绿色) */
        .bg-blue { background: linear-gradient(135deg, #11998e, #38ef7d); } /* 世界书 */
        .bg-red { background: linear-gradient(135deg, #ff9966, #ff5e62); } /* 微博 */
        .bg-purple { background: linear-gradient(135deg, #834d9b, #d04ed6); } /* 美化 */

        /* ================== Dock栏 ================== */
        .dock-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            height: 85px;
            background: var(--dock-bg);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border-radius: 26px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .dock-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            width: 60px;
        }
        
        .dock-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: #333;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: transform 0.2s;
            background-size: cover;
            background-position: center;
            overflow: hidden;
        }
        .dock-icon i { pointer-events: none; }
        .dock-item:active .dock-icon { transform: scale(0.9); }
        .dock-text { font-size: 10px; color: var(--text-color); font-weight: 500; }

        .icon-api { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .icon-theme { background: linear-gradient(135deg, #434343 0%, black 100%); }
        .icon-info { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }

        /* 外观设置页面特有样式 */
        .appearance-section { margin-bottom: 25px; }
        .appearance-title { font-size: 14px; color: var(--secondary-text); margin-bottom: 10px; padding-left: 5px; }
        
        .theme-options { display: flex; gap: 15px; }
        .theme-opt { 
            flex: 1; padding: 15px; background: #fff; border-radius: 12px; 
            text-align: center; border: 2px solid transparent; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .theme-opt.active { border-color: #007aff; color: #007aff; }
        
        .bg-upload-area {
            background: #fff; padding: 20px; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            cursor: pointer; border: 2px dashed #ddd;
        }
        .bg-preview {
            width: 100%; height: 120px; object-fit: cover; border-radius: 8px;
            background: #f0f0f0; display: none;
        }
        
        .icon-grid-edit {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
        }
        .icon-edit-item {
            display: flex; flex-direction: column; align-items: center; gap: 5px;
        }
        .icon-edit-preview {
            width: 50px; height: 50px; border-radius: 12px; background: #eee;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; overflow: hidden; position: relative;
            background-size: cover; background-position: center;
        }
        .icon-edit-label { font-size: 10px; color: #666; text-align: center; }

        /* ================== 子页面通用 ================== */
        .sub-page {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding-top: 50px; /* 避开状态栏 */
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .page-header {
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .page-title { font-size: 24px; font-weight: bold; color: var(--text-color); }
        .close-btn { 
            background: #e0e0e0; border: none; width: 30px; height: 30px; 
            border-radius: 50%; color: #333; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        /* 纪念日列表 */
        .memo-list { padding: 20px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .memo-item {
            background: #fff; padding: 20px; border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
            position: relative;
            user-select: none; -webkit-user-select: none; /* 禁止选中文本 */
            cursor: pointer;
        }
        /* 确保点击穿透子元素，直接触发item事件 */
        .memo-item * { pointer-events: none; }
        
        .memo-info h3 { font-size: 16px; margin-bottom: 5px; color: #333; }
        .memo-info p { font-size: 12px; color: #888; }
        .memo-days { font-size: 24px; font-weight: bold; color: #ff5e62; }
        
        /* 纪念日添加按钮 */
        .fab-add {
            position: absolute; bottom: 40px; right: 30px;
            width: 56px; height: 56px; border-radius: 50%;
            background: #007aff; color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 4px 15px rgba(0,122,255,0.4);
            cursor: pointer;
        }

        /* 添加卡片样式 */
        .add-memo-card {
            background: #fff;
            border-radius: 16px;
            height: 90px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border: 2px dashed #e0e0e0;
            color: #ccc;
            transition: all 0.2s;
            margin-bottom: 5px; /* 与列表项的间距 */
        }
        .add-memo-card:active { background: #f9f9f9; border-color: #007aff; color: #007aff; }
        .add-icon-circle {
            width: 40px; height: 40px;
            border-radius: 50%;
            border: 2px solid currentColor;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
        }

        /* 居中菜单遮罩 */
        .menu-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
            animation: fadeIn 0.2s ease;
        }
        
        /* 居中菜单主体 */
        .center-menu {
            background: rgba(255,255,255,0.95);
            width: 200px;
            padding: 25px 20px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: popInMenu 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .menu-btn {
            padding: 12px;
            border-radius: 25px;
            border: 1px solid #eee;
            background: #fff;
            font-size: 15px;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.1s;
        }
        .menu-btn:active { transform: scale(0.95); background: #f5f5f5; }
        
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        @keyframes popInMenu { from{transform:scale(0.8);opacity:0} to{transform:scale(1);opacity:1} }

        /* API页面样式 */
        .api-form { padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .form-row label { display: block; margin-bottom: 8px; font-size: 14px; color: var(--secondary-text); }
        .form-row input, .form-row select { 
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd;
            background: #fff; font-size: 14px;
        }
        .btn-primary {
            background: #007aff; color: white; border: none; padding: 14px;
            border-radius: 12px; font-weight: 600; font-size: 16px; margin-top: 10px; cursor: pointer;
        }

        /* 弹窗通用 */
        .modal-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-box {
            width: 80%; background: white; border-radius: 20px; padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .modal-title { text-align: center; margin-bottom: 20px; font-weight: bold; font-size: 18px; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn { flex: 1; padding: 10px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; }
        .modal-btn.confirm { background: #007aff; color: white; }
        .modal-btn.cancel { background: #f0f0f0; color: #333; }

    </style>
</head>
<body>

    <div class="iphone-container">
        <!-- 状态栏 -->
        <div class="status-bar">
            <div id="clock">12:00</div>
            <div class="sb-right">
                <i class="fas fa-signal"></i>
                <i class="fas fa-wifi"></i>
                <span id="batteryLevel" style="font-size:12px; margin-right:2px;">100%</span>
                <i class="fas fa-battery-full battery-icon" id="batteryIcon"></i>
            </div>
        </div>

        <!-- 主页面 -->
        <div class="scroll-area">
            <div class="page-content">
                
                <!-- 模块B: 用户资料 -->
                <div class="user-card">
                    <div class="avatar-container">
                        <div class="avatar" id="userAvatar" onclick="openAvatarModal()"></div>
                    </div>
                    <input type="text" class="status-input" placeholder="输入你想说的话..." id="userStatusInput" onchange="saveUserStatus(this.value)">
                </div>

                <!-- 模块 C & D: 中间功能区 -->
                <div class="mid-section">
                    <!-- 左侧：纪念日 -->
                    <div class="memorial-widget" onclick="openPage('page-memorial')" id="memorialWidget">
                        <div class="memorial-empty" id="memoEmptyState">
                            <i class="fas fa-plus-circle" style="font-size:30px;"></i>
                            <span>点击设置纪念日</span>
                        </div>
                        <img src="" class="memorial-bg" id="memoWidgetBg" style="display:none;">
                        <div class="memorial-overlay" id="memoWidgetOverlay" style="display:none;">
                            <div class="memorial-label" id="memoWidgetTitle">纪念日</div>
                            <div class="memorial-count" id="memoWidgetDays">0天</div>
                        </div>
                    </div>

                    <!-- 右侧：应用网格 -->
                    <div class="app-grid">
                        <div class="app-item" onclick="showToast('‘微信’功能开发中')">
                            <div class="app-icon" id="icon-wechat" style="background: #07c160;"><i class="fas fa-comment"></i></div>
                            <span class="app-label">微信</span>
                        </div>
                        <div class="app-item" onclick="showToast('‘世界书’功能开发中')">
                            <div class="app-icon" id="icon-worldbook" style="background: #3498db;"><i class="fas fa-book"></i></div>
                            <span class="app-label">世界书</span>
                        </div>
                        <div class="app-item" onclick="showToast('‘微博’功能开发中')">
                            <div class="app-icon" id="icon-weibo" style="background: #e6162d;"><i class="fab fa-weibo"></i></div>
                            <span class="app-label">微博</span>
                        </div>
                        <div class="app-item" onclick="showToast('‘美化’功能开发中')">
                            <div class="app-icon" id="icon-beauty" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"><i class="fas fa-palette"></i></div>
                            <span class="app-label">美化</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- 模块E: Dock栏 -->
        <div class="dock-container">
            <div class="dock-item" onclick="openPage('page-api')">
                <div class="dock-icon icon-api" id="dock-api"><i class="fas fa-cog"></i></div>
                <span class="dock-text">API设置</span>
            </div>
            <div class="dock-item" onclick="openPage('page-appearance')">
                <div class="dock-icon icon-theme" id="dock-theme"><i class="fas fa-adjust"></i></div>
                <span class="dock-text">外观</span>
            </div>
            <div class="dock-item" onclick="showPhoneInfo()">
                <div class="dock-icon icon-info" id="dock-info"><i class="fas fa-info"></i></div>
                <span class="dock-text">查手机</span>
            </div>
        </div>

        <!-- ================= 子页面: 外观设置 ================= -->
        <div id="page-appearance" class="sub-page">
            <div class="page-header">
                <button class="close-btn" onclick="closePage('page-appearance')"><i class="fas fa-chevron-left"></i></button>
                <div class="page-title">外观</div>
                <div style="width:30px"></div>
            </div>
            <div style="padding: 20px; overflow-y:auto; padding-bottom:100px;">
                
                <div class="appearance-section">
                    <div class="appearance-title">整体风格</div>
                    <div class="theme-options">
                        <div class="theme-opt active" id="themeOptLight" onclick="setTheme('light')">日间</div>
                        <div class="theme-opt" id="themeOptDark" onclick="setTheme('dark')">夜间</div>
                    </div>
                </div>

                <div class="appearance-section">
                    <div class="appearance-title">背景图片 (应用于桌面)</div>
                    <label class="bg-upload-area">
                        <span id="bgUploadText">选择文件上传</span>
                        <input type="file" accept="image/*" hidden onchange="handleBgUpload(this)">
                        <img id="bgPreview" class="bg-preview">
                    </label>
                </div>

                <div class="appearance-section">
                    <div class="appearance-title">桌面图标更改 (点击图标上传)</div>
                    <div class="icon-grid-edit">
                        <!-- 主页应用 -->
                        <div class="icon-edit-item" onclick="triggerIconUpload('icon-wechat')">
                            <div class="icon-edit-preview" id="edit-icon-wechat" style="background: #07c160;"><i class="fas fa-comment"></i></div>
                            <span class="icon-edit-label">微信</span>
                        </div>
                        <div class="icon-edit-item" onclick="triggerIconUpload('icon-worldbook')">
                            <div class="icon-edit-preview" id="edit-icon-worldbook" style="background: #3498db;"><i class="fas fa-book"></i></div>
                            <span class="icon-edit-label">世界书</span>
                        </div>
                        <div class="icon-edit-item" onclick="triggerIconUpload('icon-weibo')">
                            <div class="icon-edit-preview" id="edit-icon-weibo" style="background: #e6162d;"><i class="fab fa-weibo"></i></div>
                            <span class="icon-edit-label">微博</span>
                        </div>
                        <div class="icon-edit-item" onclick="triggerIconUpload('icon-beauty')">
                            <div class="icon-edit-preview" id="edit-icon-beauty" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"><i class="fas fa-palette"></i></div>
                            <span class="icon-edit-label">美化</span>
                        </div>
                        <!-- Dock 应用 -->
                        <div class="icon-edit-item" onclick="triggerIconUpload('dock-api')">
                            <div class="icon-edit-preview" id="edit-dock-api" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"><i class="fas fa-cog"></i></div>
                            <span class="icon-edit-label">API</span>
                        </div>
                        <div class="icon-edit-item" onclick="triggerIconUpload('dock-theme')">
                            <div class="icon-edit-preview" id="edit-dock-theme" style="background: linear-gradient(135deg, #434343 0%, black 100%);"><i class="fas fa-adjust"></i></div>
                            <span class="icon-edit-label">外观</span>
                        </div>
                        <div class="icon-edit-item" onclick="triggerIconUpload('dock-info')">
                            <div class="icon-edit-preview" id="edit-dock-info" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);"><i class="fas fa-info"></i></div>
                            <span class="icon-edit-label">查手机</span>
                        </div>
                    </div>
                    <!-- 隐藏的文件输入，用于图标上传 -->
                    <input type="file" id="iconUploadInput" accept="image/*" hidden onchange="handleIconFile(this)">
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" style="flex: 1;" onclick="saveAppearanceSettings()">保存配置</button>
                    <button class="btn-primary" style="flex: 1; background: #ff3b30;" onclick="resetAppearanceSettings()">恢复默认</button>
                </div>
            </div>
        </div>

        <!-- ================= 子页面: 纪念日 ================= -->
        <div id="page-memorial" class="sub-page">
            <div class="page-header">
                <button class="close-btn" onclick="closePage('page-memorial')"><i class="fas fa-chevron-left"></i></button>
                <div class="page-title">纪念日</div>
                <button class="close-btn" style="opacity:0; cursor:default"></button> <!-- 占位 -->
            </div>
            <div class="memo-list" id="memoList">
                <!-- 列表由JS生成 -->
            </div>
            <div class="fab-add" onclick="openMemoAddModal()">
                <i class="fas fa-plus"></i>
            </div>
        </div>

        <!-- ================= 子页面: API设置 ================= -->
        <div id="page-api" class="sub-page">
            <div class="page-header">
                <button class="close-btn" onclick="closePage('page-api')"><i class="fas fa-chevron-left"></i></button>
                <div class="page-title">API 配置</div>
                <div style="width:30px"></div>
            </div>
            <div class="api-form">
                <div class="form-row">
                    <label>API 地址</label>
                    <input type="text" id="apiUrl" placeholder="https://api.openai.com">
                </div>
                <div class="form-row">
                    <label>密钥 (Key)</label>
                    <input type="password" id="apiKey" placeholder="sk-...">
                </div>
                <div class="form-row">
                    <label>模型 (Model)</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="apiModel" placeholder="gpt-3.5-turbo" style="flex:1">
                        <button style="padding:0 15px; border-radius:10px; border:1px solid #ddd; background:#f9f9f9;" onclick="fetchModels()">获取</button>
                    </div>
                    <select id="modelSelect" style="margin-top:5px; display:none;" onchange="document.getElementById('apiModel').value=this.value">
                        <option>选择模型...</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="saveApiSettings()">保存配置</button>
            </div>
        </div>

        <!-- ================= 弹窗: 头像上传 ================= -->
        <div class="modal-mask" id="modalAvatar">
            <div class="modal-box">
                <div class="modal-title">更换头像</div>
                <div class="form-row" style="margin-bottom:15px;">
                    <label>网络图片链接</label>
                    <input type="text" id="avatarUrlInput" placeholder="http://...">
                </div>
                <div class="form-row" style="text-align:center; margin-bottom:15px;">
                    <label>或 本地上传</label>
                    <input type="file" id="avatarFileInput" accept="image/*" style="margin-top:5px;">
                </div>
                <div class="modal-actions">
                    <button class="modal-btn cancel" onclick="closeModal('modalAvatar')">取消</button>
                    <button class="modal-btn confirm" onclick="confirmAvatarChange()">确定</button>
                </div>
            </div>
        </div>

        <!-- ================= 弹窗: 添加纪念日 ================= -->
        <div class="modal-mask" id="modalMemoAdd">
            <div class="modal-box">
                <div class="modal-title">添加纪念日</div>
                <div class="form-row" style="margin-bottom:10px;">
                    <label>事件名称</label>
                    <input type="text" id="newMemoTitle" placeholder="例如: 恋爱纪念日">
                </div>
                <div class="form-row" style="margin-bottom:10px;">
                    <label>日期</label>
                    <input type="date" id="newMemoDate">
                </div>
                <div class="form-row" style="margin-bottom:10px;">
                    <label>计数方式</label>
                    <select id="newMemoType" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
                        <option value="since">正数 (已过)</option>
                        <option value="until">倒数 (未来)</option>
                    </select>
                </div>
                <div class="form-row" style="margin-bottom:10px;">
                    <label>背景图</label>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <input type="text" id="newMemoBg" placeholder="粘贴图片链接..." style="font-size:12px;">
                        <div style="font-size:12px; text-align:center; color:#888;">- 或 -</div>
                        <input type="file" id="newMemoFile" accept="image/*" style="font-size:12px;">
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="modal-btn cancel" onclick="closeModal('modalMemoAdd')">取消</button>
                    <button class="modal-btn confirm" onclick="addNewMemo()">添加</button>
                </div>
            </div>
        </div>

        <!-- ================= 弹窗: 查手机 ================= -->
        <div class="modal-mask" id="modalPhoneInfo">
            <div class="modal-box">
                <div class="modal-title">本机信息</div>
                <div style="line-height: 1.8; color: #333;">
                    <p><strong>型号：</strong> iPhone 15 Pro (Clone)</p>
                    <p><strong>系统：</strong> iOS 17.0 (WebOS)</p>
                    <p><strong>存储：</strong> 128 GB</p>
                    <p><strong>电池：</strong> <span id="infoBattery">100%</span></p>
                </div>
                <div class="modal-actions">
                    <button class="modal-btn confirm" onclick="closeModal('modalPhoneInfo')">关闭</button>
                </div>
            </div>
        </div>

        <!-- 长按菜单 DOM (居中) -->
        <div class="menu-overlay" id="contextMenuOverlay" onclick="closeContextMenu(event)">
            <div class="center-menu" id="contextMenu">
                <button class="menu-btn" onclick="handlePin()">置顶</button>
                <button class="menu-btn" onclick="handleUnpin()">取消置顶</button>
                <button class="menu-btn" onclick="handleDelete()" style="color: #ff3b30;">删除</button>
            </div>
        </div>

    </div>

    <script>
        // ================= 全局状态与初始化 =================
        const state = {
            memorials: JSON.parse(localStorage.getItem('memorials') || '[]'),
            avatar: localStorage.getItem('avatar') || '',
            status: localStorage.getItem('status') || '',
            api: JSON.parse(localStorage.getItem('api') || '{}'),
            theme: localStorage.getItem('theme') || 'light',
            bgImage: localStorage.getItem('bgImage') || '',
            customIcons: JSON.parse(localStorage.getItem('customIcons') || '{}'),
            contextMenuTargetId: null,
            tempIconTarget: null // 临时存储正在更换图标的目标ID
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            initClock();
            initBattery();
            loadUserData();
            updateMemorialWidget(); // 首页小组件
            applyAppearance(); // 应用外观设置
        });

        // ================= 功能模块A: 状态栏 =================
        function initClock() {
            const update = () => {
                const now = new Date();
                const str = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
                document.getElementById('clock').textContent = str;
            };
            setInterval(update, 1000);
            update();
        }

        function initBattery() {
            if ('getBattery' in navigator) {
                navigator.getBattery().then(battery => {
                    const updateBattery = () => {
                        const level = Math.round(battery.level * 100);
                        document.getElementById('batteryLevel').textContent = level + '%';
                        document.getElementById('infoBattery').textContent = level + '%';
                        // 更新图标
                        const icon = document.getElementById('batteryIcon');
                        icon.className = 'fas battery-icon';
                        if (battery.charging) icon.classList.add('fa-bolt');
                        else if (level > 80) icon.classList.add('fa-battery-full');
                        else if (level > 50) icon.classList.add('fa-battery-three-quarters');
                        else if (level > 20) icon.classList.add('fa-battery-quarter');
                        else icon.classList.add('fa-battery-empty');
                    };
                    updateBattery();
                    battery.addEventListener('levelchange', updateBattery);
                    battery.addEventListener('chargingchange', updateBattery);
                });
            }
        }

        // ================= 功能模块B: 用户资料 =================
        function loadUserData() {
            if(state.avatar) document.getElementById('userAvatar').style.backgroundImage = `url('${state.avatar}')`;
            if(state.status) document.getElementById('userStatusInput').value = state.status;
        }

        function saveUserStatus(val) {
            state.status = val;
            localStorage.setItem('status', val);
        }

        function openAvatarModal() {
            document.getElementById('modalAvatar').style.display = 'flex';
        }

        function confirmAvatarChange() {
            const urlInput = document.getElementById('avatarUrlInput');
            const fileInput = document.getElementById('avatarFileInput');
            
            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    updateAvatar(e.target.result);
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else if (urlInput.value) {
                updateAvatar(urlInput.value);
            }
        }

        function updateAvatar(src) {
            state.avatar = src;
            localStorage.setItem('avatar', src);
            document.getElementById('userAvatar').style.backgroundImage = `url('${src}')`;
            closeModal('modalAvatar');
            // 清理输入
            document.getElementById('avatarUrlInput').value = '';
            document.getElementById('avatarFileInput').value = '';
        }

        // ================= 功能模块D: 纪念日 =================
        function updateMemorialWidget() {
            // 查找置顶的，如果没有则显示第一个，如果列表为空显示空状态
            const pinned = state.memorials.find(m => m.isPinned) || state.memorials[0];
            const widgetBg = document.getElementById('memoWidgetBg');
            const widgetOverlay = document.getElementById('memoWidgetOverlay');
            const widgetEmpty = document.getElementById('memoEmptyState');
            const widget = document.getElementById('memorialWidget');

            if (pinned) {
                const days = calculateDays(pinned.date);
                const isFuture = pinned.type === 'until';
                const prefix = isFuture ? '还有' : '已经';
                
                document.getElementById('memoWidgetTitle').textContent = `${pinned.title} ${prefix}`;
                document.getElementById('memoWidgetDays').textContent = `${Math.abs(days)} 天`;
                
                if (pinned.bg) {
                    widgetBg.src = pinned.bg;
                    widgetBg.style.display = 'block';
                    widget.style.background = '#fff'; // 重置背景色
                } else {
                    // 无图片时显示渐变
                    widgetBg.style.display = 'none';
                    widget.style.background = 'linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)';
                }
                
                widgetOverlay.style.display = 'flex';
                widgetEmpty.style.display = 'none';
            } else {
                widgetBg.style.display = 'none';
                widgetOverlay.style.display = 'none';
                widgetEmpty.style.display = 'flex';
                widget.style.background = '#fff';
            }
        }

        function calculateDays(dateStr) {
            const target = new Date(dateStr);
            const today = new Date();
            target.setHours(0,0,0,0); today.setHours(0,0,0,0);
            return Math.floor((today - target) / (1000 * 60 * 60 * 24));
        }

        function openMemoAddModal() {
            document.getElementById('newMemoDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('newMemoTitle').value = '';
            document.getElementById('newMemoBg').value = '';
            document.getElementById('newMemoFile').value = '';
            document.getElementById('modalMemoAdd').style.display = 'flex';
        }

        function addNewMemo() {
            const title = document.getElementById('newMemoTitle').value;
            const date = document.getElementById('newMemoDate').value;
            const type = document.getElementById('newMemoType').value;
            const urlBg = document.getElementById('newMemoBg').value;
            const fileInput = document.getElementById('newMemoFile');

            if (!title || !date) return alert('请填写标题和日期');

            const save = (finalBg) => {
                const newMemo = {
                    id: Date.now(),
                    title,
                    date,
                    type, // since or until
                    bg: finalBg,
                    isPinned: false
                };
                state.memorials.push(newMemo);
                saveMemorials();
                renderMemoList();
                closeModal('modalMemoAdd');
            };

            // 处理文件上传
            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => save(e.target.result);
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                save(urlBg);
            }
        }

        function renderMemoList() {
            const list = document.getElementById('memoList');
            list.innerHTML = '';
            
            const sorted = [...state.memorials].sort((a,b) => (b.isPinned?1:0) - (a.isPinned?1:0));

            sorted.forEach(item => {
                const days = calculateDays(item.date);
                const isFuture = item.type === 'until';
                const el = document.createElement('div');
                el.className = 'memo-item';
                if(item.isPinned) el.style.border = '2px solid #007aff';
                
                // 允许长按
                el.oncontextmenu = (e) => {
                    e.preventDefault();
                    showContextMenu(e, item.id);
                };

                el.innerHTML = `
                    <div class="memo-info">
                        <h3>${item.title}</h3>
                        <p>${item.date} ${isFuture ? '(倒数)' : '(已过)'}</p>
                    </div>
                    <div class="memo-days">${Math.abs(days)} <span style="font-size:12px;color:#888;">天</span></div>
                `;

                // 触摸设备长按模拟
                let timer;
                const start = (e) => {
                    timer = setTimeout(() => showContextMenu(e, item.id), 600);
                };
                const end = () => clearTimeout(timer);
                
                el.addEventListener('touchstart', start);
                el.addEventListener('touchend', end);
                el.addEventListener('touchmove', end); // 移动则取消长按
                
                // PC鼠标长按（mousedown）已经在上面 oncontextmenu 覆盖了右键，这里补充左键长按
                el.addEventListener('mousedown', (e) => {
                    if(e.button === 0) start(e);
                });
                el.addEventListener('mouseup', end);
                el.addEventListener('mouseleave', end);
                
                list.appendChild(el);
            });
        }

        function showContextMenu(e, id) {
            e.preventDefault();
            state.contextMenuTargetId = id;
            // 显示居中菜单
            document.getElementById('contextMenuOverlay').style.display = 'flex';
        }

        function closeContextMenu(e) {
            // 点击遮罩层时关闭
            if (e.target.id === 'contextMenuOverlay') {
                document.getElementById('contextMenuOverlay').style.display = 'none';
            }
        }

        function handlePin() {
            const id = state.contextMenuTargetId;
            state.memorials.forEach(m => m.isPinned = (m.id === id));
            saveMemorials();
            renderMemoList();
            document.getElementById('contextMenuOverlay').style.display = 'none';
        }

        function handleUnpin() {
            const id = state.contextMenuTargetId;
            const target = state.memorials.find(m => m.id === id);
            if(target) target.isPinned = false;
            saveMemorials();
            renderMemoList();
            document.getElementById('contextMenuOverlay').style.display = 'none';
        }

        function handleDelete() {
            const id = state.contextMenuTargetId;
            // 短暂延时让菜单关闭动画（如果需要），或者直接关闭
            document.getElementById('contextMenuOverlay').style.display = 'none';
            
            setTimeout(() => {
                if(confirm('确定删除?')) {
                    state.memorials = state.memorials.filter(m => m.id !== id);
                    saveMemorials();
                    renderMemoList();
                }
            }, 100);
        }

        function saveMemorials() {
            localStorage.setItem('memorials', JSON.stringify(state.memorials));
            updateMemorialWidget();
        }

        // ================= 页脚功能区 & API =================
        function saveApiSettings() {
            state.api = {
                url: document.getElementById('apiUrl').value.replace(/\/$/, ''),
                key: document.getElementById('apiKey').value,
                model: document.getElementById('apiModel').value
            };
            localStorage.setItem('api', JSON.stringify(state.api));
            alert('API 配置已保存');
            closePage('page-api');
        }

        async function fetchModels() {
            const key = document.getElementById('apiKey').value;
            let url = document.getElementById('apiUrl').value.replace(/\/$/, '');
            if(!key || !url) return alert('请先填写地址和Key');

            const btn = event.target;
            btn.textContent = '...';
            btn.disabled = true;

            try {
                // 尝试标准的 OpenAI 格式 /v1/models
                const res = await fetch(`${url}/v1/models`, {
                    headers: { 'Authorization': `Bearer ${key}` }
                });
                if(!res.ok) throw new Error('请求失败: ' + res.status);
                
                const data = await res.json();
                const select = document.getElementById('modelSelect');
                select.innerHTML = '<option value="">选择模型...</option>';
                
                // 兼容不同格式的返回
                const list = data.data || data.models || [];
                if(list.length === 0) throw new Error('未找到模型');
                
                list.sort((a,b) => a.id.localeCompare(b.id)).forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.textContent = m.id;
                    select.appendChild(opt);
                });
                
                select.style.display = 'block';
                alert(`获取成功，共 ${list.length} 个模型`);
            } catch (err) {
                alert('获取失败: ' + err.message);
                // 即使失败也提供默认选项以便用户继续
                const select = document.getElementById('modelSelect');
                select.style.display = 'block';
                select.innerHTML = `
                    <option value="gpt-3.5-turbo">gpt-3.5-turbo (默认)</option>
                    <option value="gpt-4">gpt-4</option>
                `;
            } finally {
                btn.textContent = '获取';
                btn.disabled = false;
            }
        }

        // ================= 外观设置逻辑 =================
        function applyAppearance() {
            // 应用主题
            if(state.theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('themeOptDark').classList.add('active');
                document.getElementById('themeOptLight').classList.remove('active');
            } else {
                document.documentElement.removeAttribute('data-theme');
                document.getElementById('themeOptLight').classList.add('active');
                document.getElementById('themeOptDark').classList.remove('active');
            }

            // 应用背景图
            if(state.bgImage) {
                document.querySelector('.iphone-container').style.backgroundImage = `url('${state.bgImage}')`;
                document.getElementById('bgPreview').src = state.bgImage;
                document.getElementById('bgPreview').style.display = 'block';
                document.getElementById('bgUploadText').style.display = 'none';
            }

            // 应用自定义图标
            for (const [id, src] of Object.entries(state.customIcons)) {
                const el = document.getElementById(id);
                const editEl = document.getElementById('edit-' + id);
                if(el) {
                    el.style.backgroundImage = `url('${src}')`;
                    el.querySelector('i').style.display = 'none'; // 隐藏原有 FontAwesome 图标
                }
                if(editEl) {
                    editEl.style.backgroundImage = `url('${src}')`;
                    editEl.querySelector('i').style.display = 'none';
                }
            }
        }

        function setTheme(mode) {
            state.theme = mode;
            if(mode === 'light') {
                document.getElementById('themeOptLight').classList.add('active');
                document.getElementById('themeOptDark').classList.remove('active');
                document.documentElement.removeAttribute('data-theme');
            } else {
                document.getElementById('themeOptDark').classList.add('active');
                document.getElementById('themeOptLight').classList.remove('active');
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        }

        function handleBgUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const src = e.target.result;
                    state.bgImage = src;
                    // 预览
                    document.getElementById('bgPreview').src = src;
                    document.getElementById('bgPreview').style.display = 'block';
                    document.getElementById('bgUploadText').style.display = 'none';
                    // 实时应用到桌面以便查看
                    document.querySelector('.iphone-container').style.backgroundImage = `url('${src}')`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function triggerIconUpload(id) {
            state.tempIconTarget = id;
            document.getElementById('iconUploadInput').click();
        }

        function handleIconFile(input) {
            if (input.files && input.files[0] && state.tempIconTarget) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const src = e.target.result;
                    state.customIcons[state.tempIconTarget] = src;
                    
                    // 更新设置页预览
                    const editEl = document.getElementById('edit-' + state.tempIconTarget);
                    if(editEl) {
                        editEl.style.backgroundImage = `url('${src}')`;
                        editEl.querySelector('i').style.display = 'none';
                    }
                    
                    // 实时更新主页/Dock图标
                    const mainEl = document.getElementById(state.tempIconTarget);
                    if(mainEl) {
                        mainEl.style.backgroundImage = `url('${src}')`;
                        mainEl.querySelector('i').style.display = 'none';
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
            // 重置 input 以便允许重复选择同一文件
            input.value = '';
        }

        function saveAppearanceSettings() {
            localStorage.setItem('theme', state.theme);
            localStorage.setItem('bgImage', state.bgImage);
            localStorage.setItem('customIcons', JSON.stringify(state.customIcons));
            alert('外观设置已保存');
            closePage('page-appearance');
        }

        function resetAppearanceSettings() {
            if(!confirm('确定要恢复默认主题吗？这将清除所有自定义背景和图标。')) return;

            // 1. 重置状态数据
            state.theme = 'light';
            state.bgImage = '';
            state.customIcons = {};

            // 2. 清除本地存储
            localStorage.removeItem('theme');
            localStorage.removeItem('bgImage');
            localStorage.removeItem('customIcons');

            // 3. 恢复主题 (Light)
            setTheme('light');

            // 4. 恢复背景图
            document.querySelector('.iphone-container').style.backgroundImage = '';
            document.getElementById('bgPreview').src = '';
            document.getElementById('bgPreview').style.display = 'none';
            document.getElementById('bgUploadText').style.display = 'block';

            // 5. 恢复图标
            const iconIds = [
                'icon-wechat', 'icon-worldbook', 'icon-weibo', 'icon-beauty',
                'dock-api', 'dock-theme', 'dock-info'
            ];
            
            iconIds.forEach(id => {
                // 恢复主页/Dock图标
                const el = document.getElementById(id);
                if(el) {
                    el.style.backgroundImage = '';
                    const icon = el.querySelector('i');
                    if(icon) icon.style.display = '';
                }
                
                // 恢复设置页预览图标
                const editEl = document.getElementById('edit-' + id);
                if(editEl) {
                    editEl.style.backgroundImage = '';
                    const editIcon = editEl.querySelector('i');
                    if(editIcon) editIcon.style.display = '';
                }
            });

            // 提示并关闭
            alert('已恢复默认外观');
            // closePage('page-appearance'); // 可选：恢复后是否关闭页面，这里保持打开以便用户确认
        }

        function showPhoneInfo() {
            document.getElementById('modalPhoneInfo').style.display = 'flex';
        }

        // ================= 导航 & 通用 =================
        function openPage(id) {
            document.getElementById(id).style.display = 'flex';
            if(id === 'page-memorial') renderMemoList();
            if(id === 'page-api') {
                if(state.api.url) document.getElementById('apiUrl').value = state.api.url;
                if(state.api.key) document.getElementById('apiKey').value = state.api.key;
                if(state.api.model) document.getElementById('apiModel').value = state.api.model;
            }
            if(id === 'page-appearance') {
                // 确保打开时 UI 状态正确
                applyAppearance();
            }
        }

        function closePage(id) {
            document.getElementById(id).style.display = 'none';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function showToast(msg) {
            // 简单的toast提示
            const div = document.createElement('div');
            div.style.cssText = `
                position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.7); color: white; padding: 15px 25px;
                border-radius: 20px; z-index: 3000; font-size: 14px;
                backdrop-filter: blur(5px);
            `;
            div.textContent = msg;
            document.querySelector('.iphone-container').appendChild(div);
            setTimeout(() => div.remove(), 2000);
        }

    </script>
</body>
</html>
